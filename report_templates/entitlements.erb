<%#
name: Subscription - Entitlement Report
snippet: false
model: ReportTemplate
template_inputs:
- name: days_from_now
  required: false
  input_type: user
  description: "Show subscriptions expiring in <= this many days.  Leave blank to show all entitlements."
  advanced: false
  value_type: plain
  options: "7\r\n30\r\n60\r\n90\r\n120\r\n180"
require:
- plugin: katello
  version: 3.16.0
-%>
<%- load_hosts(includes: [:lifecycle_environment, :operatingsystem, :architecture, :content_view, :organization, :reported_data, :subscription_facet, :pools => [:subscription]]).each_record do |host| -%>
<%-   days_from_now = input('days_from_now').to_i -%>
<%-   should_filter = !input('days_from_now').empty? -%>
<%-   host.pools.each do |pool| -%>
<%-     next if should_filter && pool.expiring_in_days > days_from_now -%>
<%-     report_row(
          'Host Name': host.name,
          'Organization': host.organization,
          'Lifecycle Environment': host.lifecycle_environment,
          'Content View': host.content_view,
          'Host Collections': host_collections_names(host),
          'Virtual': host.virtual,
          'Guest of Host': host.hypervisor_host,
          'OS': host.operatingsystem,
          'Arch': host.architecture,
          'Sockets': host.sockets,
          'RAM': host.ram,
          'Cores': host.cores,
          'SLA': host_sla(host),
          'Products': host_products_names(host),
          'Subscription Name': sub_name(pool),
          'Subscription Type': pool.type,
          'Subscription Quantity': pool.quantity,
          'Subscriptions Consumed': pool.consumed,
          'Subscription SKU': sub_sku(pool),
          'Subscription Contract': pool.contract_number,
          'Subscription Account': pool.account_number,
          'Subscription Start': pool.start_date,
          'Subscription End': pool.end_date,
          'Subscription Guest': registered_through(host),
          'Subscription Ends In': "#{pool.expiring_in_days} days"
          ) -%>
<%-   end -%>
<%- end -%>
<%= report_render -%>
